% -*- mode: prolog -*-

get(X-Y, V) :-
    map(L), nth1(Y, L, R), string_code(X, R, C),
    to_lower(C, C1), char_code(V, C1).

is_open('.').

is_portal(C) :- char_type(C, alpha).

% Preprocessing - find the portal coordinates to generate rules

find_portal(P1, P2, P3, Swap) :-
    get(P1, V1), is_portal(V1),
    get(P2, V2), is_portal(V2),
    write('portal('),
    ( Swap, write(V2), write(V1)
    ; \+ Swap, write(V1), write(V2)
    ),
    write(','), write(P2),
    write(','), write(P3),
    write(').'), nl.

print_portals :- find_portal(X-1, X-2, X-3, false), fail.
print_portals :- find_portal(X-35, X-34, X-33, true), fail.
print_portals :- find_portal(X-91, X-92, X-93, false), fail.
print_portals :- find_portal(X-125, X-124, X-123, true), fail.
print_portals :- find_portal(1-Y, 2-Y, 3-Y, false), fail.
print_portals :- find_portal(35-Y, 34-Y, 33-Y, true), fail.
print_portals :- find_portal(89-Y, 90-Y, 91-Y, false), fail.
print_portals :- find_portal(123-Y, 122-Y, 121-Y, true), fail.

% Main code (almost the same as in Day 18)

step(P, P) :- get(P, V), is_open(V).
step(P, P1) :-
    get(P, V), is_portal(V),
    portal(A, P, _),
    portal(A, Q, P1), Q \= P.

adjacent(X-Y, P) :- X1 is X - 1, step(X1-Y, P).
adjacent(X-Y, P) :- X1 is X + 1, step(X1-Y, P).
adjacent(X-Y, P) :- Y1 is Y - 1, step(X-Y1, P).
adjacent(X-Y, P) :- Y1 is Y + 1, step(X-Y1, P).

shortest_path(From, To, Length) :-
    shortest_path([path(From,0)], To, [path(From,0)], Length).

shortest_path([path(P,K)|F], T, L, N) :-
    findall(A, adjacent(P, A), As),
    ( member(T, As), N is K + 1
    ; neighbor_paths(As, L, K, L1),
      append(F, L1, F1), append(L1, L, L2),
      shortest_path(F1, T, L2, N)
    ).

neighbor_paths([], _, _, []).
neighbor_paths([P|Ps], L, K, L1) :-
    member(path(P,K1), L), K + 1 >= K1,
    !, neighbor_paths(Ps, L, K, L1).
neighbor_paths([P|Ps], L, K, [path(P,K1)|L1]) :-
    K1 is K + 1,
    neighbor_paths(Ps, L, K, L1).

adv20(X) :-
    portal(aa, _, From),
    portal(zz, _, To),
    shortest_path(From, To, X), !.

% Generated portal data

portal(jg,42-2,42-3).
portal(lv,50-2,50-3).
portal(pm,54-2,54-3).
portal(pi,66-2,66-3).
portal(vo,70-2,70-3).
portal(tr,72-2,72-3).
portal(xc,80-2,80-3).
portal(fz,40-34,40-33).
portal(og,50-34,50-33).
portal(od,60-34,60-33).
portal(xl,62-34,62-33).
portal(nb,72-34,72-33).
portal(uy,74-34,74-33).
portal(ww,82-34,82-33).
portal(vo,38-92,38-93).
portal(jh,44-92,44-93).
portal(yp,56-92,56-93).
portal(tr,64-92,64-93).
portal(ck,70-92,70-93).
portal(br,76-92,76-93).
portal(oa,84-92,84-93).
portal(og,40-124,40-123).
portal(ck,46-124,46-123).
portal(nb,54-124,54-123).
portal(xl,62-124,62-123).
portal(fz,66-124,66-123).
portal(sl,76-124,76-123).
portal(ww,82-124,82-123).
portal(pl,2-38,3-38).
portal(yp,2-44,3-44).
portal(ev,2-50,3-50).
portal(wv,2-58,3-58).
portal(aa,2-62,3-62).
portal(el,2-72,3-72).
portal(uy,2-76,3-76).
portal(zz,2-86,3-86).
portal(jh,2-88,3-88).
portal(el,34-40,33-40).
portal(th,34-48,33-48).
portal(xc,34-56,33-56).
portal(pi,34-60,33-60).
portal(wv,34-72,33-72).
portal(xp,34-76,33-76).
portal(ev,34-88,33-88).
portal(pm,90-40,91-40).
portal(lv,90-50,91-50).
portal(un,90-62,91-62).
portal(sl,90-70,91-70).
portal(pl,90-76,91-76).
portal(jg,90-86,91-86).
portal(br,122-42,121-42).
portal(un,122-50,121-50).
portal(od,122-58,121-58).
portal(oa,122-64,121-64).
portal(xp,122-72,121-72).
portal(th,122-84,121-84).

% Data

map(['                                         J       L   P           P   V T       X                                           ',
     '                                         G       V   M           I   O R       C                                           ',
     '  #######################################.#######.###.###########.###.#.#######.#########################################  ',
     '  #...#.........#.#...#.#...#.........#.....#.#.....#.......#...#...#.....#.#...........#...........#.......#...#.......#  ',
     '  ###.#########.#.#.###.#.#######.###.###.###.#####.#.###.###.#####.###.###.#####.#.#######.#####.###.#.#####.#####.#####  ',
     '  #.#.....#...........#...#...#.#.#.....#.....#.#...#.#.....#.#.#.....#.....#.....#.#.#.#.......#.#...#.....#.#.#.....#.#  ',
     '  #.#####.#####.###.#####.###.#.#######.#.#.###.#.#####.###.#.#.#.#########.#.#.#####.#.###.#######.#.#######.#.###.###.#  ',
     '  #...#...#.....#...#.#...#.#.#...#.#.....#.#.......#...#.#.#...#.#.#.......#.#.#...............#.#.#.........#.#.#.....#  ',
     '  ###.#.#.#########.#.###.#.#.#.###.#.#.#########.#####.#.#.#.#.#.#.###.#####.###.#.#.#.###.#.###.###.#######.#.#.#.#####  ',
     '  #.....#...#.....#.........#...#.#...#.........#.....#.#...#.#.....#.....#.#.#...#.#.#.#...#...........#...#.........#.#  ',
     '  #########.#####.#.#.#.#.#.###.#.#######.#####.###.#####.###.###.###.#####.#.#.###.#.#.###.#.#####.#.###.#########.###.#  ',
     '  #.#.........#.....#.#.#.#.#.......#.......#.#.#.......#.#...#.#...#...#...#.....#.#.#...#.#.....#.#.............#.#...#  ',
     '  #.###.###.#####.#########.###.#####.###.#.#.#####.#####.###.#.###.#.###.###.#.###.#######.###.#.#.#.#######.#####.###.#  ',
     '  #...#...#.....#.#.#...#.........#...#...#.#.....#.#.#.....#...#...#.......#.#.#.........#...#.#.#.#.......#.#...#.#.#.#  ',
     '  #.#########.###.#.#.#####.#.###.###.#######.###.#.#.#.###.###.###.#.#.#.###.#####.#.###.#.#.###.#.#.#.#######.#.###.#.#  ',
     '  #...#.......#.#.#.....#.#.#.#...........#.....#.....#.#...#.....#.#.#.#.#.......#.#.#...#.#.#.#.#.#.#...#...#.#.#.#...#  ',
     '  #.#########.#.###.###.#.###########.#########.###########.#.###.###.###.#########.#########.#.#####.#.###.###.###.###.#  ',
     '  #...#.#.#.......#.#.....#.....#.....#.#.......#.#...#.#...#...#.#.#.#.#.#...#...........#.#.....#...#.....#...#.......#  ',
     '  ###.#.#.#####.#####.###.#####.#####.#.#####.###.###.#.###.#.#####.#.#.###.#######.#######.#.#######.#.###.###.#####.###  ',
     '  #.....#.#.#.#.....#.#.#.........#.#.....#.#...........#...#.....#.........#...#...#...#...#.#.#...#.#.#.#...#.#.#.....#  ',
     '  #.#.#.#.#.#.#.#######.#########.#.###.###.###.#####.#####.#.#######.#########.###.###.###.###.#.#####.#.#####.#.#.#.###  ',
     '  #.#.#.......#.....#.#.#.#.#.#.#.#.....#...#...#.#.#.#...#.#.#.#.#.....#...#...#...#...#.....#.....#.#.#.#...#...#.#.#.#  ',
     '  #####.#####.#.#####.#.#.#.#.#.#.###.#####.#.###.#.###.###.#.#.#.#.#.###.###.#.#.#####.#.#.#######.#.###.#.#####.###.#.#  ',
     '  #.#.#.#.....#.....#.......................#...#...#.......#.....#.#.#.......#.#.........#...#.#.#.#...#.....#.#.#.....#  ',
     '  #.#.#######.#.#######.###.#.#####.#######.#.#####.#.#.###.###.#####.#######.#.###.#######.#.#.#.#.#.#####.###.#.###.###  ',
     '  #...#...........#.#.#.#...#.#...#.#...#.#.#.....#...#...#.#...#...........#.#...#.....#.#.#...........#...#...#.#...#.#  ',
     '  ###.#.#.###.#.###.#.#.#.#####.#####.###.#.#.#######.#.#.#.#.###########.###.###.#.#.#.#.#.#.#.#.###.#.###.###.#.#.#.#.#  ',
     '  #.....#.#.#.#.#.....#.#...#...#.#.#.....#.#.....#...#.#.#.#...#.#.#...#.#...#.#.#.#.#.#.#.#.#.#.#.#.#...#.......#.#...#  ',
     '  ###.#.#.#.#.#####.###########.#.#.#.###.#.#.#####.#.#######.###.#.#.#.#.#.#.#.#.#.#####.#.#######.#######.#.###.#.#####  ',
     '  #.#.#.#.#...#.#.......#.......#.....#.#.#.#...#.#.#.......#.......#.#...#.#.#.#...#.#...#.#...#...#...#...#.#...#.....#  ',
     '  #.#########.#.###.#.#####.#.#.#####.#.#.#.###.#.###.###.#########.#.#######.#.#####.###.###.###.#####.#########.###.###  ',
     '  #.....#.#.#.#.....#...#...#.#.#.......#...#.....#.....#...#.......#.....#.................#...#...#.........#.#.#.#...#  ',
     '  #.#####.#.#.#######.#######.#########.#########.#########.#.#########.#.#######.#########.#.###.#####.#######.#.#.#.###  ',
     '  #.....#.#.#.#...#.#.#.#.#.#...#      F         O         O X         N U       W        #.#.....#.#.#...#.#.#.........#  ',
     '  #.#####.#.#.#.###.#.#.#.#.#.###      Z         G         D L         B Y       W        ###.#####.#.###.#.#.###.###.###  ',
     '  #...#.#.#.#.#.#...#.......#...#                                                         #.......#.....#...#...#.#.#...#  ',
     '  #.###.#.#.#.#.###.#.#.###.#.#.#                                                         #.#.#######.###.#.###.#.#.#.###  ',
     'PL....#.#.#...#...#...#...#...#.#                                                         #.#.#.#.#...#.#.#.....#.#.#.#.#  ',
     '  #.###.#.###.#.###.#.#.#.###.#.#                                                         #.###.#.#.###.###.#######.#.#.#  ',
     '  #.......#.#.......#.#.#.#...#..EL                                                     PM..#.........#.#.....#.#.......#  ',
     '  #.#.#.###.###.#.#.###########.#                                                         #.###.###.###.#.#.#.#.###.###.#  ',
     '  #.#.#.........#.#.#.....#...#.#                                                         #.#.#...#.......#.#.......#....BR',
     '  #############.#.#####.###.#####                                                         #.#.###.#########.#.#.###.###.#  ',
     'YP..#.........#.#...#.#.#.#.....#                                                         #.#...#.....#.#.#.#.#...#...#.#  ',
     '  #.#.###.#.#####.###.#.#.###.#.#                                                         #.#.#.###.###.#.###########.#.#  ',
     '  #...#.#.#.#.#.#.#...#.....#.#.#                                                         #...#.....#.#.#.#...#.#...#.#.#  ',
     '  #.###.###.#.#.###.#.#.#.###.###                                                         ###########.#.#.#.###.###.###.#  ',
     '  #...#.#...........#...#........TH                                                       #.......#...............#...#.#  ',
     '  ###.#.#####################.###                                                         #.#####.#.###.###.#####.#.#.###  ',
     'EV..#.#...#.................#...#                                                       LV..#.#.....#...#...#.#.#...#.#..UN',
     '  #.###.#.#####.#.###.#.#.###.###                                                         #.#.#.###.###.#.#.#.#.#####.#.#  ',
     '  #.#...#...#...#.#...#.#.#.#...#                                                         #.#...#.#.#.#.#.#.#.#.......#.#  ',
     '  #.#.#####.#.#.#.###.###.#.#####                                                         #######.###.#######.#.#######.#  ',
     '  #.#.#.....#.#.#...#.#.#.......#                                                         #.#.......#.....#.#.#.........#  ',
     '  #.#.#.#######.#######.###.#.#.#                                                         #.#####.#.###.###.#.###########  ',
     '  #...#...........#...#...#.#.#..XC                                                       #...#.#.#.........#...........#  ',
     '  #######.#########.###.###.#####                                                         #.#.#.###.###.###.###.#.#.#.###  ',
     'WV..#.#.#.#...............#.#.#.#                                                         #.#...#.#.#.#.#.......#.#.#....OD',
     '  #.#.#.#.#.#.#.###.#####.###.#.#                                                         #.###.#.#.#.#########.#########  ',
     '  #.....#.#.#.#...#.#.....#.#.#..PI                                                       #.#.....#...#.....#.#.....#...#  ',
     '  #####.###.#####.#.#####.#.#.#.#                                                         #.#.#.#.###.###.###.#########.#  ',
     'AA........#.....#.#.#...#.......#                                                       UN..#.#.#.....#...#...#.#.#.#...#  ',
     '  #.#######.###########.###.###.#                                                         ###.###########.###.#.#.#.###.#  ',
     '  #...........#.#.#.#.....#.#.#.#                                                         #...#...#.......#..............OA',
     '  #.#.#.#.#.#.#.#.#.###.#####.###                                                         #####.#.#.#.###.#.#.###.###.#.#  ',
     '  #.#.#.#.#.#.....#.............#                                                         #.#...#...#.#.....#.#...#...#.#  ',
     '  #################.#########.###                                                         #.#.###.#.#########.###########  ',
     '  #.....#.#.#.#.......#.....#...#                                                         #.#...#.#.#.......#.#.#.....#.#  ',
     '  #.#.###.#.#.#######.#.###.###.#                                                         #.#.###.#.#.#########.#.#####.#  ',
     '  #.#.#...#...#.#...#.....#.#.#.#                                                       SL....#.#.#.#.#.#.....#...#.#...#  ',
     '  #.#.#.#.#.###.#.#.#######.#.#.#                                                         #####.#####.#.#.#.#####.#.#.###  ',
     'EL..#...#.........#.........#.#..WV                                                       #...............#.#.#..........XP',
     '  #.###########.###.#########.###                                                         #.#########.###.###.###.#####.#  ',
     '  #.#.......#...#...#...........#                                                         #.#.....#...#...#...#.......#.#  ',
     '  ###.#####.###.#########.#.###.#                                                         #.#.###.#.#.#####.#.#####.#.#.#  ',
     'UY..#...#.....#.#.........#.#....XP                                                     PL..#...#...#.#.#.#.#...#...#.#.#  ',
     '  #.#.###.#.###########.#.#.#####                                                         #.###.#######.#.###.#.#.#####.#  ',
     '  #.#.#...#.#.#.#.#.#...#.#.....#                                                         #...#...............#.....#.#.#  ',
     '  #.#.#.#####.#.#.#.###.###.#####                                                         #.#.###############.#.#.###.#.#  ',
     '  #...#...................#.....#                                                         #.#.#...........#...#.#.#...#.#  ',
     '  ###############.###############                                                         #.#.###.#######.###########.###  ',
     '  #...........#.#.#.............#                                                         #.#.#.....#...........#...#.#.#  ',
     '  #####.#.#.###.###.#######.###.#                                                         #########.#.#.###########.#.#.#  ',
     '  #.....#.#.#.#.#.........#.#...#                                                         #.#.#.....#.#.#...#...#...#....TH',
     '  #.#####.###.#.#######.#####.###                                                         #.#.###.#.#.#########.###.#.#.#  ',
     'ZZ....#...#...#.#...........#.#.#                                                       JG........#.#.................#.#  ',
     '  ###.#.###.#.#.###.#.#.#####.#.#                                                         #.###.#.###.#.#.#####.###.#.###  ',
     'JH....#.....#.......#.#...#......EV                                                       #.#...#...#.#.#...#.....#.#...#  ',
     '  #.#.#######.#.#####.#.#####.###                                                         #.###.#########.###.#.#####.#.#  ',
     '  #.#.#.......#.#.#.#.#.....#.#.#                                                         #.#...#...........#.#.#.#...#.#  ',
     '  #.#.###.#.#.###.#.#.#######.#.#    V     J           Y       T     C     B       O      #.#####.###.#.###.#.###.###.#.#  ',
     '  #.#.#...#.#...#.....#.#.......#    O     H           P       R     K     R       A      #.#.....#...#...#.#.#.#.....#.#  ',
     '  #.#.#.#.###.#.#.#.#.#.#.###.#.#####.#####.###########.#######.#####.#####.#######.###############.#.#.#.###.#.#.#.#.###  ',
     '  #.#.#.#.#...#.#.#.#...#...#.#.#.......#.......#...#.....#.....#.......#...#...#.........#.#.#.....#.#.#.#.#.#...#.#.#.#  ',
     '  ###.#####.#.#######.###.###.#######.#####.#####.###.#######.###.#######.###.#.#.#.#.###.#.#.###.#####.###.#########.#.#  ',
     '  #.....#.#.#.....#...#...#.#.#...........#.........#.....#...#.#.....#.#.....#.#.#.#.#.....#...#.#.#.........#.........#  ',
     '  #.#####.#.###.#####.#####.#.#.###.###.#.###.#.###.#####.#.#.#.#.#####.###.###.#.#####.#.###.#####.###.###.###.#.#.###.#  ',
     '  #...#...#...#.#.........#...#.#...#.#.#.#.#.#...#.#.....#.#...#.......#.#.#...#.#...#.#.#.....#.#.....#.....#.#.#.#...#  ',
     '  #######.#####.#####.#######.#####.#.#.###.#####.#####.###.###########.#.#####.#.#.#########.###.###.#.###.#######.###.#  ',
     '  #.......#.#.....#...#.........#...#.#.#...#.........#...#.#.#.......#...#.#.#.#...#...#...#.#.....#.#.#.#.#.........#.#  ',
     '  #.#.#.#.#.#.#####.#####.###.#####.#.#.#.#####.#.#.#.###.#.#.#####.#.#.###.#.#.#.###.###.###.###.###.###.###.#.###.#####  ',
     '  #.#.#.#.......#...#...#.#...#.......#.#...#...#.#.#.#.#.#.....#...#.#.....#...#...#.#.#.........#.#...#...#.#.#.......#  ',
     '  #######.###.###.#.#.###############.###.#####.###.###.#.#.#.#.#.#.#.#.###.###.###.#.#.#.###.#.###.###.#.#.#.#####.#.#.#  ',
     '  #...#.#.#.....#.#.#.#.........#.#.........#.....#.#...#.#.#.#.#.#.#.....#.#...#...#...#...#.#.....#.#.#.#.......#.#.#.#  ',
     '  #.###.###.#.#####.#.#########.#.#######.#.###.#####.###.#.#.#####.###.#######.#.###.###.#######.#.#.#####.#.#.#.###.###  ',
     '  #.....#...#...#.#.....#...............#.#.#.....#.......#.#.#.....#.#...#.....#.....#.....#.....#.....#.#.#.#.#.#.....#  ',
     '  #####.#.#.###.#.#.#########.#####.###.#.###.###.#######.#.#####.###.#.#.#####.#.###.#.#.#######.#.#.###.#.#######.#.#.#  ',
     '  #.......#.#.#.#.....#.......#.#...#.#.....#.#...#.#.#...#...#.......#.#.#.....#.#.....#...#...#.#.#.#.......#.#.#.#.#.#  ',
     '  #.###.#.#.#.###.#######.#####.#.#.#####.#.###.###.#.#.#.#.#####.#####.#####.###.#.###.###.#.###.#.###########.#.#.#.#.#  ',
     '  #.#.#.#.#...#...#...#.#.#.#.#.#.#.....#.#...#...#.....#.#...#.#.....#.#.......#.#.#...#.#.....#.#.#.........#...#.#.#.#  ',
     '  #.#.#.#.#.###.#####.#.###.#.#.###.#######.#####.#.###.###.#.#.#.#############.#######.#.#.###.#####.#.###.###.#####.###  ',
     '  #.#.#.#.#...#...#.#.....................#.#.....#...#.#...#...#.#...#.#.......#...#.#...#.#.#.#.....#.#.........#.#...#  ',
     '  #.#.#.#.#.#######.#####.#####.#####.#########.#.#.#########.#.#.###.#.#####.###.###.#.#.###.#####.#########.#####.#####  ',
     '  #.#...#.#.#...#.........#.#.#.#.......#...#.#.#.#.........#.#.#.#.....#...........#...#.#.......#.#.#.#.#...........#.#  ',
     '  #.#######.###.###.#######.#.#####.#####.###.#.#######.#####.###.###.#.###.###.#######.#######.###.#.#.#.###.###.###.#.#  ',
     '  #.....#.#.#.#.#.#.#.#.....#.........#.........#.#...#...#.#...#.....#.#.#...#.#.#.#.#.....#...............#...#.#.....#  ',
     '  #.#####.###.#.#.###.#####.#######.#####.#.###.#.#.#.#.###.#.#########.#.#.###.#.#.#.#.#########.#####.#.#.#######.#.#.#  ',
     '  #.#.#.......................#.#.#.#...#.#.#.....#.#...#.#...#.#.#.......#.#.....#.#...#...#.........#.#.#.......#.#.#.#  ',
     '  #.#.#.###.#####.#########.#.#.#.#.#.###########.#.###.#.#.###.#.###.###.###.#####.###.###.#.#.#.#.###.#####.#.###.#####  ',
     '  #.#...#.#.#.#...#.........#.........#...#.#.....#...#.#.......#...#...#.#.....#...#.........#.#.#...#...#...#.#.#...#.#  ',
     '  #######.###.###.#####.#####.#####.#.#.###.###.###.#######.#.#.#.#####.#######.#.#.#.#####.#####.#.#.#.#####.###.#####.#  ',
     '  #...............#.....#.......#...#.....#.......#.....#...#.#.#.......#.......#.#.......#.....#.#.#.#.....#...........#  ',
     '  #####################################.#####.#######.#######.###.#########.#####.#######################################  ',
     '                                       O     C       N       X   F         S     W                                         ',
     '                                       G     K       B       L   Z         L     W                                         ']).
