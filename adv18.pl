% -*- mode: prolog -*-

get(X-Y, C) :- map(L), nth1(Y, L, R), string_code(X, R, C).

not_wall(P) :- get(P, C), !, C \= 35. % '#'

adjacent(X-Y, X1-Y) :- X1 is X - 1, not_wall(X1-Y).
adjacent(X-Y, X1-Y) :- X1 is X + 1, not_wall(X1-Y).
adjacent(X-Y, X-Y1) :- Y1 is Y - 1, not_wall(X-Y1).
adjacent(X-Y, X-Y1) :- Y1 is Y + 1, not_wall(X-Y1).

% Manually ordered keys (see adv18.txt for more readable maps)
keys([i,z,v, m,f, c,e, o,s, p,t, k, j, q,w,b, x,g,l,h, u,n,r,d,a,y]).

shortest_path(From, To, Length) :-
    shortest_path([path(From,0)], To, [path(From,0)], Length).

shortest_path([path(P,K)|F], T, L, N) :-
    findall(A, adjacent(P, A), As),
    ( member(T, As), N is K + 1
    ; neighbor_paths(As, L, K, L1),
      append(F, L1, F1), append(L1, L, L2),
      shortest_path(F1, T, L2, N)
    ).

neighbor_paths([], _, _, []).
neighbor_paths([P|Ps], L, K, L1) :-
    member(path(P,K1), L), K + 1 >= K1,
    !, neighbor_paths(Ps, L, K, L1).
neighbor_paths([P|Ps], L, K, [path(P,K1)|L1]) :-
    K1 is K + 1,
    neighbor_paths(Ps, L, K, L1).

collect_keys(_, [], 0).
collect_keys(P, [K|Ks], N) :-
    between(1, 81, X), between(1, 81, Y),
    atom_codes(K, [C]), get(X-Y, C),
    shortest_path(P, X-Y, N1),
    collect_keys(X-Y, Ks, N2),
    N is N1 + N2.

adv18(X) :- keys(K), collect_keys(41-41, K, X), !.

adv18b(X) :-
    collect_keys(40-40, [c,e,j], X1),
    collect_keys(42-40, [o,s,p,t,x,g,l,h], X2),
    collect_keys(40-42, [m,f,k,u,n,r,d,a,y], X3),
    collect_keys(42-42, [i,z,v,q,w,b], X4),
    X is X1 + X2 + X3 + X4, !.

% Data

map(['#################################################################################',
     '#.#...........#...#.....#.......#...#...#.....#.....#.....#...#...#..g.........x#',
     '#.#.#####.###Z#.#.#.###.#.#.###.#.###.#.#.###.#.#####.#.#.#.#.#.###.###########.#',
     '#...#...#.#.....#.#.#.#...#.#...#.#...#.#.#.#.#.#.....#p#.#.#.#.......#...#.....#',
     '#.#####.#.#########.#.#####.#.###.#.###.#.#.#.#.#.#####.#.#.#.#######.###.#.###.#',
     '#.......#...#.......#.....#.#.#.....#...#.#.....#...#...#...#.#.....#.....#.#...#',
     '###########.#.#########.###.#.###.###.###.#####.###.#.#######.#.###.#####.#.#.###',
     '#...V.....#.......#...#.#...#...#...#...#.#...#...#.#.#.......#.#.#.#.....#.#...#',
     '#.#######.#######.#.#.#.#.#####.#######.#.#.#.#.###.#.#######.#.#.#.#.#####B###.#',
     '#.#.......#...#.....#...#.....#.....#...#...#.#.#...#.......#...#...#.....#...#.#',
     '#.#.#####.#.#K#.#############.#####.#.#.#####.###.#########.#####.#######.###.###',
     '#.#.#.....#.#.#...#...#.......#...#.#.#.#...#.#...#...#.....#.....#....l..#.#...#',
     '#.#.#####.#.#.###.#.#.#.#######.#.#.#.###.#.#.#.###.#.#.#####.#######.#####.###.#',
     '#.#.....#.#.#...#.#.#.#.....#...#...#...#.#...#.#...#.#...#...#.....#.........#.#',
     '#.#####.#.#.###.#.#.#.#####.#####.#####.#.#####.#.#.#####.#.###.###.#######.###.#',
     '#.#...#.#.#...#.#.#.#..j..#.....#.......#.#...#...#.#...#.#.....#...#.......#...#',
     '#.#.###.#Q###.#.###.#####.#####I#######.#.#.#.#.#####.#.#.#######.#######.###.#.#',
     '#...#...#.#...#.....#...#.....#.....#...#.#.#...#.....#.#.#.#.....#.....#h..#.#.#',
     '###.#.#####.#########.#.#####.#.###.#.###.#.#####.#####.#.#.#.#####.###.#####.#.#',
     '#...#...#...#.......#.#.......#...#.#...#.#.#.....#.....#.#.....#.....#.......#.#',
     '#.#####.#.###.#####.#.###########.#.#####.#.#.#####.#####.#.###.#####.###########',
     '#.....#.#...#.#.....#.#.......#...#.#...#...#.#.......#...#.#.#.....#.....#.....#',
     '#####.#.###.#.#.###.###.###.###.###.#.#.#####.#######.###.###.#####.#####.#.###.#',
     '#.#...#...#.#.#.#...#.....#...#.#.#.#.#.#.....#...#.#.....#...#...#.....#.....#.#',
     '#.#.###.###.###.#.###########.#.#.#.#.#.#.#.###.#.#.#####.#.#####.#####.#######.#',
     '#.#...#...#.....#.#..e....#...#...#...#.#.#.#...#.#...#...#.....#.....#.#.......#',
     '#.###.###.#######.#.#####.#.#####.#####.#.###.###.#.#.#.#######.#.#.###.#.#####.#',
     '#.#...#.#...#...#...#.....#.#.........#.#.#.....#.#.#.#.......#.#.#.....#...#...#',
     '#.#.###.#.###.#.#####.#####.#.#########.#.#.#####.###.###.#####.#.#########.#.###',
     '#...#...#...#.#.....#.#.#.......#...#...#.#o#.#...#...#...#.....#.#.........#...#',
     '#.#####.###.#.#.#####.#.#.#######.#.#.#.#.#.#.#.###.###.###.#####.#####.#######U#',
     '#.........#...#...#...#...#.......#...#.#.....#...#.....#.#.#...#.#.....#.....#.#',
     '#########.#######.#.###.###.###########.#.#######.#.#####.#.#.#.#.#.#########.#.#',
     '#.......#.......#...#.....#...#.#.....#.#.#.....#.#.......#.#.#.#.#.#.......#...#',
     '#.#####.#######.#############.#.#.#.###.#.#.###.#.#########.#.###.#.#.#####.#####',
     '#.....#.#.......#.....#.......#.#.#.#...#.#.#.....#...#.....#.#...#.....#.#..tE.#',
     '#.###.###.#######.###.#.#######.#.#.#.###.#.#######.#.#.#####.#.#######.#.#####.#',
     '#.S.#...#.....#...#.#c..#...#.....#.#.#.#.#...#.....#..s#.....#.#.....#...#...#.#',
     '###.###.#####.#.###.#####.#.#.#####.#.#.#.###.#.#########.###.#.###.#.#####.#.#.#',
     '#.....#.........#.........#.......#.........#...#...........#.....F.#.......#...#',
     '#######################################.@.#######################################',
     '#m........#.............#...........#.........#.....#.........#.....#...#.......#',
     '###.#####.#########.#####.#####.###.#.#.#.#.#.#.###.#.#####.#.#.###.#.#.#.###.#.#',
     '#...#.#...#.......#...#...#...#.#.#...#.#.#.#.#...#...#...#.#.....#.#.#.#.#...#.#',
     '#.###W#.###.#####.#.#.#O###.#.#.#.#####.###.#####.#####.#.#########.#.#.#.#.###.#',
     '#.#.......#...#.#.#.#.#...#.#.#.#...#...#...#...#.....#.#.#...#...#.C.#.#.#.#...#',
     '#.#######.###.#.#.#.#.###.#.#.#.#.###.###.###.#.#.#####.#.#.#.#.#.#####.#.#.###.#',
     '#.#...#.#.#...#...#.#.#...#.#...#.......#.....#...#.....#.#.#.#.#.....#...#...#.#',
     '#.#.#.#.#.#.###.###.#.#.###.#####.#######.#########.#####.#.#.#.#####.#.#####.#.#',
     '#.#f#.#.#.#.#.#.#...#...#...#...#...#...#.#.......#...#.....#.#.#...#.#...#.#.#.#',
     '#.#.#.#.#.#.#.#.#.#######.###.###.###.#D#.###.#.#####.#######.#.#.###.###.#.#.#.#',
     '#...#.#...#.#...#.....#.#...#.....#...#.#...#.#.#...#.....#.#.#.#.....#.....#.#.#',
     '#####.#.###.#.#######.#.###.###.###.###.###.#.###.#.#####.#.#.#.#.#####.#####.#.#',
     '#.....#...#.#.#...#...#...#...#.#a..#.#.#.#.#.....#.....#.#...#.#w#...#...#...#.#',
     '#.#######.#.#.#.#.#.###.#####.###.###.#.#.#.#.#######.###.#.###.#.#.#####.#.###.#',
     '#.#.....#.#.#.#.#.#...#.#...#...#...#.#.#...#.....#...#...#...#.#.#.......#.#...#',
     '#.###.#.#.#.#.#.#.###.#.#.#.#.#.###.#.#.#.#########.#.#.#####.#M#.#########.###.#',
     '#...#.#...#.#...#.#.....#.#.#.#...#.#..d#.#.........#.#.#.......#...#.....#...#.#',
     '#.#.#.#####.#####.#######.#.#####.#.#.###.###.#####.###.#.#########.#.###.###.#.#',
     '#.#.#...#...#.............#.......#.#...#.#i..#.....#...#.#.......#...#.#...#.#.#',
     '###.###.#.###.#################.###A###.#.#.###.#####.###.#.#####.#####.###.#.###',
     '#...#.....#.#.#.....#.Y...#...#.#...#.#.#...#.#.#.#...#...#.#.N...#.........#...#',
     '#.###.#####.#.#.###.#####.###.#.#.###.#.#####.#.#.#.###.###.#############.#####.#',
     '#...#.#...#...#.#.#.....#...#...#.#...R.#.#.....#.#...#...#.....#...#...#q....#.#',
     '#.#.###.#.#.###.#.###.#.###.#####.#.#####.#.#####.###.#########.#.#.#.#.#####.#.#',
     '#.#...#.#.#.#...#...#.#...#..y....#.#...#.#.#.......#.........#...#...#...#.#.#.#',
     '#####.#.#.###.###.#.#.###.#########.#.#.#.#.#.#####.#########.###########.#.#.#.#',
     '#...#.#.#...#.#...#.#...#.....#...#.#.#.#.#.#.#.............#.#...#.....#.#.#.#.#',
     '#.#.#.#.###.#.#.#######.#####.#.#.#.###.#.#.#.#.#######.#####.#.#.#.###.#.#.#.#.#',
     '#.#...#.#.#.#...#.......#...#.#.#r..#...#...#.#.#.....#.#...#...#.#...#...#.#.#.#',
     '#T###.#.#.#.###.#.#######.#.###.#####.###.#####.#.###.#.#.#.#####.###.#####.#.#.#',
     '#.#...#u..#.....#...#...#n#...#.#.#.....#.#...#.#...#.#.#.#.#.......#.....#.....#',
     '#.#.#####.#########.#.#H#.###.#.#.#.###.#.#.#.#.#.###.#.#.#J#.###########.#####.#',
     '#.#.....#.#...#...#.#.#...#.#...#.#...#.#...#.#...#...#.#.#...#.........#.....#.#',
     '#.#######.#.###.#.#.#.#####.#####.###.#.#####.#.###.#####.#.###.#####.#######.#.#',
     '#.#.......#.#...#...#...#.....L.#.....#.#.#...#..v#z..#...#.#...#...#.......#.#.#',
     '#.#.#######.#.###.#####.#.#####.#######.#.#.#########.#.#####.###.#.###.#####.#.#',
     '#.#.#k......#...#.#...#...#.....#.....#.#.#.....#...#.#..b....#...#...#...#...#.#',
     '#.#.#.#####.###.###.#.#####.#####.###.#.#.#####.#.#.#.#############.#.###X#.###.#',
     '#.....#.......#...G.#.............#.....#.........#...P.............#...#...#...#',
     '#################################################################################']).
